#!/bin/sh

# Ask for the administrator password upfront
sudo -v

# IMPORTANT: Make sure you update the `DST` variable to
# match the name of the destination backup drive

PROG=$0
SRC="/"
DST="/Volumes/backup/"
EXCLUDE="$HOME/.dotfiles/.backupignore"

# -v                      increase verbosity
# -a                      turns on archive mode (recursive copy + retain attributes)
# -x                      don't cross device boundaries (ignore mounted volumes)
# -S                      handles spare files efficiently
# -H                      preserves hard-links
# --acls                  update the destination ACLs to be the same as the source ACLs
# --delete                delete any files that have been deleted locally
# --delete-excluded       delete any files (on DST) that are part of the list of excluded files
# --exclude-from          reference a list of files to exclude
# --xattrs                update the remote extended attributes to be the same as the local ones

if [ ! -r "$SRC" ]; then
  logger -t $PROG "Source $SRC not readable - Cannot start the sync process"
  exit;
fi

if [ ! -w "$DST" ]; then
  logger -t $PROG "Destination $DST not writeable - Cannot start the sync process"
  exit;
fi

logger -t $PROG "Start rsync"

sudo rsync -vax -S -H --acls --delete --delete-excluded --exclude-from=$EXCLUDE "$SRC" "$DST"

logger -t $PROG "End rsync"

# make the backup bootable - comment this out if needed
sudo bless -folder "$DST"/System/Library/CoreServices

exit 0
